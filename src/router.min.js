window.STRouter=(()=>{class Router{constructor(routes){this.routes=routes,this.defaultRoute=this.getDefaultRoute,this.links=[],this.componentNames=new Set,this.__setGlobalAliases__(),this._detectMountPlace_(),this.addListener({target:document,type:"click",listener:this.__clickWatching__.bind(this),name:"_routerClickWatcher"}),this.addListener({target:window,type:"popstate",listener:this.render.bind(this),name:"_routerHistoryWatcher"})}get version(){return"1.0.4"}__setGlobalAliases__(){window.$routes=this.routes,window.$location=this.getLocation}__comparePaths__(){let componentArr="";const locationArr=this.getLocation.path.split("/");let component;return locationArr.length>2&&""==locationArr[locationArr.length-1]&&locationArr.pop(),this.routes.forEach(item=>{let compareArr=[];(componentArr=item.path.split("/")).length==locationArr.length&&(componentArr.forEach((str,i)=>{-1==str.indexOf(":")&&str===locationArr[i]?compareArr.push(1):-1==str.indexOf(":")&&str!==locationArr[i]&&""==locationArr[i]?compareArr.push(0):str.indexOf(":")>-1?compareArr.push(1):compareArr.push(0)}),compareArr.some(num=>0==num)||(component=item))}),component}__typeOfComponent__(component){switch(typeof component){case"function":return component();case"object":return component}}__cleanListeners(){Object.keys(this.listeners).forEach(item=>{0==this.listeners[item].length&&delete this.listeners[item]}),0!=Object.keys(this.listeners).length||delete this.listeners}__runChildrenBeforeMount(parent){let map=[];const recursion=parent=>{Object.keys(parent.children).forEach(name=>{const child=this.__typeOfComponent__(parent.children[name]);"beforeMount"in child&&map.push(child.beforeMount()),"children"in child&&recursion(child)})};return recursion(parent),map.filter(item=>void 0!==item)}__clickWatching__(e){if(!e.target.hasAttribute("download"))if("A"!==e.target.tagName){let parent=e.target.parentNode;for(;"A"!==parent.tagName;)if(null==(parent=parent.parentNode)||!parent.tagName)return;"A"==parent.tagName&&RegExp(location.origin).test(parent.href)&&(e.preventDefault(),this.links.push(parent.href),history.pushState("","",parent.href),this.render())}else RegExp(location.origin).test(e.target.href)&&(e.preventDefault(),this.links.push(e.target.href),history.pushState("","",e.target.href),this.render())}_detectMountPlace_(){if(0==document.getElementsByTagName("router-view").length){const error=new Error('STR-Warn: Не установлены точки монтирования. Missing "<router-view>" tag.');console.warn(error.message)}}_setMountPlace_(){let routerViews=document.getElementsByTagName("router-view");if(0==routerViews.length)return;for(let i=0;i<routerViews.length;i++){this.componentNames.add(routerViews[i].getAttribute("name"));let div=document.createElement("div");div.setAttribute("name",`component-${routerViews[i].getAttribute("name")}`),routerViews[i].insertAdjacentElement("beforebegin",div)}const removeRouterView=()=>{for(let i=0;i<document.getElementsByTagName("router-view").length;i++)document.getElementsByTagName("router-view")[i].remove();document.getElementsByTagName("router-view").length>0&&removeRouterView()};removeRouterView()}_clearMountPlace_(){this.componentNames.forEach(name=>{document.getElementsByName(`component-${name}`).forEach(node=>node.innerHTML="")})}_renderChildComponent_(parentComponent){let parentTemplate=parentComponent.template;return Promise.resolve().then(()=>{const __main=parent=>{if("children"in parent){const childNames=Object.keys(parent.children);childNames.forEach(name=>{const reg=`<router.*?s*name[^w]*${name}[^w]*></[^w]*router.*?>`,child=this.__typeOfComponent__(parent.children[name]);let template=child.template;if("methods"in child&&(template=this._runMethods_(child)),RegExp(reg,"g").test(parentTemplate)){const regExec=RegExp(reg,"g");let routerView,views=[];for(;null!==(routerView=regExec.exec(parentTemplate));)views=views.concat(routerView);views.forEach(view=>parentTemplate=parentTemplate.replace(RegExp(view),template))}"mounted"in child&&child.mounted(),"children"in child&&__main(child)})}},__asyncFun=async()=>(await Promise.all(this.__runChildrenBeforeMount(parentComponent)),__main(parentComponent),parentTemplate);return __asyncFun()})}_runMethods_(component,temp){const reg=/[^{]+(?=}})/gi;let template=temp||component.template;const methods=component.methods;let strMethods=[],tempMethod;for(;null!==(tempMethod=reg.exec(template));)strMethods=strMethods.concat(tempMethod);return strMethods.forEach(method=>{method&&methods[method]&&(template=template.replace(RegExp(`{{${method}}}`),methods[method]()))}),template}_setActiveLinks_(){const links=document.getElementsByTagName("a");setTimeout(()=>{Object.keys(links).forEach(link=>{document.getElementsByTagName("a")[link].href==location.href?document.getElementsByTagName("a")[link].classList.add("router-link-active"):document.getElementsByTagName("a")[link].classList.remove("router-link-active")})},100)}get getLocation(){return{hash:location.hash,href:location.href,origin:location.origin,path:location.pathname,search:location.search}}get getDefaultRoute(){let defaultRoute;if(this.routes&&(defaultRoute=this.routes.find(item=>"*"==item.path)),!defaultRoute){const error=new Error("STR-Warn: Не задан маршрут по-умолчанию. Default route is not defined.");console.warn(error.message)}return defaultRoute}getRouteComponents(){if(this.routes){const components=this.__comparePaths__();return components||this.defaultRoute}{const error=new Error("STR-Warn: Не заданы маршруты. Routes are not defined.");return void console.warn(error.message)}}addListener({target:target,type:type,listener:listener,options:options,name:name,once:once}){Object.keys(arguments[0]).length<4||("listeners"in this||(this.listeners={}),type in this.listeners||(this.listeners[type]=[]),this.listeners[type].push({target:target,type:type,listener:listener,options:options||void 0,name:name,once:once||!1}),target.addEventListener(type,listener,options||void 0))}removeListeners(arg){if(this.__cleanListeners(),this.listeners){if(0==arguments.length)return Object.keys(this.listeners).forEach(listenerType=>{this.listeners[listenerType].forEach(item=>{1==item.once&&item.target.removeEventListener(item.type,item.listener,item.options)}),this.listeners[listenerType]=this.listeners[listenerType].filter(item=>0==item.once)}),void this.__cleanListeners();if(1==arguments.length){if("string"==typeof arg){if("_routerClickWatcher"==arg||"_routerHistoryWatcher"==arg)return;return Object.keys(this.listeners).forEach(listenerType=>{this.listeners[listenerType].forEach(item=>{item.name==arg&&item.target.removeEventListener(item.type,item.listener,item.options)}),this.listeners[listenerType]=this.listeners[listenerType].filter(item=>item.name!==arg)}),void this.__cleanListeners()}if("object"==typeof arg){if("name"in arg){if("_routerClickWatcher"==arg.name||"_routerHistoryWatcher"==arg.name)return;return Object.keys(this.listeners).forEach(listenerType=>{this.listeners[listenerType].forEach(item=>{item.name==arg.name&&item.target.removeEventListener(item.type,item.listener,item.options)}),this.listeners[listenerType]=this.listeners[listenerType].filter(item=>item.name!==arg)}),void this.__cleanListeners()}if("target"in arg&&1==Object.keys(arg).length)return Object.keys(this.listeners).forEach(listenerType=>{this.listeners[listenerType].forEach(item=>{(item.target==arg.target&&"_routerClickWatcher"!==item.name||item.target==arg.target&&"_routerHistoryWatcher"!==item.name)&&item.target.removeEventListener(item.type,item.listener,item.options)}),this.listeners[listenerType]=this.listeners[listenerType].filter(item=>item.target==arg.target&&"_routerClickWatcher"==item.name||item.target==arg.target&&"_routerHistoryWatcher"==item.name?item:item.target!==arg.target?item:void 0)}),void this.__cleanListeners();if("type"in arg&&1==Object.keys(arg).length&&arg.type in this.listeners)return this.listeners[arg.type]=this.listeners[arg.type].filter(item=>{if("_routerClickWatcher"==item.name||"_routerHistoryWatcher"==item.name)return item;item.target.removeEventListener(arg.type,item.listener,item.options)}),void this.__cleanListeners()}}else console.log("STRouter.removeListeners выбросил исключение")}}render(){this._setMountPlace_();const routeComponents=this.getRouteComponents();routeComponents&&(this._clearMountPlace_(),this.removeListeners(),this.componentNames.forEach(name=>{if(name in routeComponents.components){const __promise=component=>{const __buss=(component,template)=>{template=template||component.template,"methods"in component&&(template=this._runMethods_(component,template)),document.getElementsByName(`component-${name}`).forEach(node=>node.insertAdjacentHTML("beforeend",template)),"mounted"in component&&component.mounted(),scrollTo(0,0)};"children"in component?this._renderChildComponent_(component).then(res=>__buss(component,res)):__buss(component)},component=this.__typeOfComponent__(routeComponents.components[name]);if("beforeMount"in component){const beforeMount=component.beforeMount();beforeMount&&"[object Promise]"==beforeMount.toString()?beforeMount.then(()=>__promise(component)):__promise(component)}else __promise(component)}}),this._setActiveLinks_())}}return Router.version=Router.prototype.version,Router.getLocation=Router.prototype.getLocation,Router})();